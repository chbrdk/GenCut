# üé¨ GenCut - Vollst√§ndige Projektdokumentation

## üìã Inhaltsverzeichnis

1. [Projekt√ºbersicht](#projekt√ºbersicht)
2. [Architektur & Services](#architektur--services)
3. [Detaillierte Code-Analyse](#detaillierte-code-analyse)
4. [Verwaiste Dateien & Code-Bereinigung](#verwaiste-dateien--code-bereinigung)
5. [Code-Qualit√§t & Verbesserungsvorschl√§ge](#code-qualit√§t--verbesserungsvorschl√§ge)
6. [Deployment & Konfiguration](#deployment--konfiguration)
7. [API-Dokumentation](#api-dokumentation)

---

## üìä Projekt√ºbersicht

**GenCut** ist eine microservice-basierte Video-Analyse-Plattform, die Videos automatisch analysiert, Szenen erkennt, Transkriptionen erstellt und intelligente Cutdowns generiert. Das System nutzt AI-Modelle f√ºr visuelle Analyse und Audio-Transkription.

### üèóÔ∏è Technologie-Stack

- **Backend**: Python (FastAPI, Flask)
- **AI/ML**: PyTorch, Transformers, YOLO, Whisper
- **Video-Processing**: FFmpeg, OpenCV, PySceneDetect
- **Container**: Docker, Docker Compose
- **Reverse Proxy**: Nginx
- **Frontend**: HTML, TailwindCSS, JavaScript

### üìÅ Projektstruktur

```
GenCut/
‚îú‚îÄ‚îÄ services/                    # Microservices
‚îÇ   ‚îú‚îÄ‚îÄ analyzer/               # Video-Analyse & KI
‚îÇ   ‚îú‚îÄ‚îÄ cutdown-generator/      # Frontend & Cutdown-Generation
‚îÇ   ‚îú‚îÄ‚îÄ revoice/               # Voice & Lip-Sync
‚îÇ   ‚îú‚îÄ‚îÄ upload-service/        # Upload-Handler
‚îÇ   ‚îî‚îÄ‚îÄ whisper/               # Speech-to-Text
‚îú‚îÄ‚îÄ templates/                  # HTML-Templates
‚îú‚îÄ‚îÄ static/                     # CSS & Assets
‚îú‚îÄ‚îÄ docker-compose.yml          # Service-Orchestrierung
‚îú‚îÄ‚îÄ nginx.conf                  # Reverse Proxy Config
‚îî‚îÄ‚îÄ build-and-run.sh           # Setup-Script
```

---

## üèõÔ∏è Architektur & Services

### üîÑ Service-Architektur

Das System folgt einer **Microservices-Architektur** mit klarer Trennung der Verantwortlichkeiten:

```mermaid
graph TB
    A[Nginx Proxy] --> B[Cutdown Generator]
    A --> C[Revoice Service]
    
    B --> D[Analyzer Service]
    B --> E[Whisper Service]
    
    D --> F[Visual Analysis AI]
    D --> G[Scene Detection]
    E --> H[Speech-to-Text AI]
    
    B --> I[n8n Workflows]
    C --> I
```

### üì¶ Service-Details

#### 1. **Analyzer Service** (Port: 8000)
- **Technologie**: FastAPI, PyTorch, YOLO, BLIP
- **Zweck**: Video-Analyse, Szenen-Erkennung, KI-basierte visuelle Analyse
- **Hauptfunktionen**:
  - Szenen-Erkennung mit PySceneDetect
  - Objekt-Erkennung mit YOLO v8
  - Szenen-Beschreibung mit BLIP
  - Video/Audio-Trennung
  - Screenshot-Generierung

#### 2. **Cutdown Generator** (Port: 5679)
- **Technologie**: Flask, Gunicorn
- **Zweck**: Frontend, Upload-Handling, Cutdown-Orchestrierung
- **Hauptfunktionen**:
  - Video-Upload-Interface
  - n8n Webhook-Integration
  - Status-Monitoring
  - ElevenLabs Voice-Integration
  - Musik-Generation Proxy

#### 3. **Whisper Service** (Port: 9000)
- **Technologie**: FastAPI, OpenAI Whisper
- **Zweck**: Audio-zu-Text Transkription
- **Hauptfunktionen**:
  - Mehrsprachige Transkription
  - Spracherkennung
  - Segment-basierte Analyse

#### 4. **Revoice Service** (Port: 5682)
- **Technologie**: Flask
- **Zweck**: Video-Upload f√ºr Lip-Sync und Voice-Replacement
- **Hauptfunktionen**:
  - Video-Upload f√ºr Revoicing
  - ElevenLabs Voice-Integration
  - Session-Management
  - n8n Lip-Sync Workflow-Integration

#### 5. **Upload Service** (Port: 5679)
- **Technologie**: Flask
- **Zweck**: Legacy Upload-Handler f√ºr Lip-Sync
- **Status**: ‚ö†Ô∏è **Potentiell veraltet** - √úberschneidung mit anderen Services

---

## üîç Detaillierte Code-Analyse

### üìÑ Analyzer Service (`services/analyzer/`)

#### `main.py` - Haupt-API-Server
```python
# Zentrale FastAPI-Anwendung mit 15 Endpunkten
# Wichtigste Funktionen:

@app.post("/analyze")           # Video-Analyse mit KI
@app.post("/analyze-path")      # Analyse von Dateipfaden
@app.post("/separate-path")     # Video/Audio-Trennung
@app.post("/cutdown-path")      # Video-Schnitt
@app.post("/generate-cutdown")  # Cutdown-Generierung
```

**Code-Qualit√§t**: ‚≠ê‚≠ê‚≠ê (Gut)
- Umfangreiche Funktionalit√§t
- Gute Fehlerbehandlung
- Dokumentierte Funktionen

**Verbesserungspotential**:
- Sehr lange Datei (800+ Zeilen)
- Gemischte Verantwortlichkeiten
- Fehlende Type-Hints in einigen Funktionen

#### `visual_analysis.py` - KI-Modell-Integration
```python
class VisualAnalyzer:
    def __init__(self):
        self.models_initialized = False
        self.scene_description_model = None  # BLIP
        self.object_detection_model = None   # YOLO
        
    async def analyze_image(self, image_path: str) -> dict:
        # Kombiniert BLIP + YOLO f√ºr vollst√§ndige Analyse
```

**Code-Qualit√§t**: ‚≠ê‚≠ê‚≠ê‚≠ê (Sehr gut)
- Saubere Klassenstruktur
- Async/Await korrekt implementiert
- Gute Modell-Abstraktion

#### `scene_utils.py` - Szenen-Erkennung
```python
def analyze_scenes(video_path: str, threshold: float | None = None, 
                  min_scene_len: int | None = None):
    # PySceneDetect + OpenCV f√ºr Screenshot-Generierung
    # Optimiert f√ºr Performance (nur mittlere Frames)
```

**Code-Qualit√§t**: ‚≠ê‚≠ê‚≠ê‚≠ê (Sehr gut)
- Klare Funktion
- Gute Performance-Optimierungen
- Konfigurierbare Parameter

#### `ffmpeg_utils.py` - Video-Processing
```python
def cut_clip(input_path, output_path, start_time, end_time):
    # FFmpeg-Integration f√ºr Video-Schnitt
    # Validierung und Fehlerbehandlung
    
def separate_video_audio(video_path, output_dir):
    # Trennung von Video/Audio-Streams
```

**Code-Qualit√§t**: ‚≠ê‚≠ê‚≠ê (Gut)
- Robuste FFmpeg-Integration
- Gute Validierung
- Ausf√ºhrliche Logging

### üìÑ Cutdown Generator (`services/cutdown-generator/`)

#### `app.py` - Frontend & Orchestrierung
```python
# Flask-Anwendung mit 15+ Endpunkten
# Hauptfunktionen:

@app.route('/upload', methods=['POST'])     # Video-Upload
@app.route('/check-status', methods=['POST']) # Status-Pr√ºfung
@app.route('/generate-music', methods=['POST']) # Musik-Generation
@app.route('/elevenlabs/*')                 # Voice-Integration
```

**Code-Qualit√§t**: ‚≠ê‚≠ê‚≠ê (Gut)
- Umfangreiche Funktionalit√§t
- n8n Integration
- ElevenLabs API-Integration

**Kritische Punkte**:
- **Hardcodierter API-Key**: `ELEVENLABS_API_KEY = 'sk_76fa...'`
- Sehr lange Datei (630+ Zeilen)
- Gemischte Verantwortlichkeiten

### üìÑ Whisper Service (`services/whisper/`)

#### `main.py` - Speech-to-Text
```python
@app.post("/asr")
async def transcribe_audio(audio_file: UploadFile = File(...), 
                          language_code: str = Form(None)):
    # OpenAI Whisper Integration
    # Tempor√§re Datei-Verarbeitung
```

**Code-Qualit√§t**: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Exzellent)
- Sehr sauberer, fokussierter Code
- Korrekte Async-Implementation
- Gute Ressourcen-Verwaltung

### üìÑ Revoice Service (`services/revoice/`)

#### `app.py` - Voice & Lip-Sync
```python
# Flask-Service f√ºr Revoicing
# ElevenLabs Integration
# n8n Webhook-Integration

@app.route('/upload', methods=['POST'])
@app.route('/status/<video_id>')
@app.route('/elevenlabs/voices')
```

**Code-Qualit√§t**: ‚≠ê‚≠ê‚≠ê (Gut)
- Klare Service-Trennung
- Session-Management
- ElevenLabs Integration

**Kritische Punkte**:
- **Hardcodierter API-Key**: `ELEVENLABS_API_KEY = 'sk_76fa...'`
- Duplikation mit anderen Services

---

## üóëÔ∏è Verwaiste Dateien & Code-Bereinigung

### üìÇ Identifizierte verwaiste Dateien:

#### 1. **`templates_old/` Verzeichnis**
```
templates_old/
‚îú‚îÄ‚îÄ index.html          # ‚ö†Ô∏è Veraltet
‚îú‚îÄ‚îÄ input.css          # ‚ö†Ô∏è Duplikat
‚îú‚îÄ‚îÄ tailwind.css       # ‚ö†Ô∏è Duplikat
‚îú‚îÄ‚îÄ static/tailwind.css # ‚ö†Ô∏è Duplikat
‚îî‚îÄ‚îÄ testfile.txt       # ‚ö†Ô∏è Test-Datei
```
**Empfehlung**: Komplettes Verzeichnis l√∂schen

#### 2. **Service-Duplikation**
- `services/upload-service/` vs `services/cutdown-generator/`
- Beide haben √§hnliche Upload-Funktionalit√§t
- `upload-service` scheint Legacy zu sein

#### 3. **Konfiguration-Inkonsistenzen**
- `services/cutdown-generator/package.json`: Name ist noch "upload-service-frontend"
- Storybook-Service ist auskommentiert aber Build-Script vorhanden

#### 4. **Ungenutzte Container**
- `imagebind-embed` Service definiert aber nicht aktiv genutzt
- Referenziert externes Verzeichnis `../imagebind-video-embed`

### üßπ Bereinigungsplan:

1. **Sofort l√∂schen**:
   - `templates_old/` komplett
   - `services/upload-service/` (nach Funktions-Migration)

2. **Konfiguration korrigieren**:
   - `package.json` Namen aktualisieren
   - Storybook-Konfiguration bereinigen

3. **Service-Konsolidierung**:
   - Upload-Funktionalit√§t in `cutdown-generator` konsolidieren
   - Doppelte ElevenLabs-Integration vereinheitlichen

---

## üìä Code-Qualit√§t & Verbesserungsvorschl√§ge

### üî¥ Kritische Sicherheitsprobleme

#### 1. **Hardcodierte API-Keys**
```python
# services/cutdown-generator/app.py:17
ELEVENLABS_API_KEY = os.environ.get('ELEVENLABS_API_KEY', 'sk_76fa8e172a657a24769b7714e73bf966e1e3297583c6a7ca')

# services/revoice/app.py:45
ELEVENLABS_API_KEY = 'sk_76fa8e172a657a24769b7714e73bf966e1e3297583c6a7ca'
```

**L√∂sung**:
```python
# Sicher: Nur Umgebungsvariable, kein Fallback
ELEVENLABS_API_KEY = os.environ.get('ELEVENLABS_API_KEY')
if not ELEVENLABS_API_KEY:
    raise ValueError("ELEVENLABS_API_KEY Umgebungsvariable ist erforderlich")
```

#### 2. **Debug-Modus in Produktion**
```python
# Mehrere Services haben DEBUG=True
app.config.update(DEBUG=True, ENV='development')
```

### üü° Code-Qualit√§tsprobleme

#### 1. **Lange Funktionen/Dateien**
- `analyzer/main.py`: 800+ Zeilen
- `cutdown-generator/app.py`: 630+ Zeilen
- `generate_cutdown_v2()`: 200+ Zeilen

**L√∂sung**: Aufteilen in kleinere Module/Funktionen

#### 2. **Fehlende Type-Hints**
```python
# Vorher
def time_string_to_seconds(time_str):
    
# Nachher  
def time_string_to_seconds(time_str: str) -> float:
```

#### 3. **Inkonsistente Fehlerbehandlung**
```python
# Manchmal:
try:
    # code
except Exception as e:
    print(f"Error: {e}")
    
# Besser:
try:
    # code
except SpecificException as e:
    logger.error(f"Specific error: {e}")
    raise HTTPException(status_code=500, detail=str(e))
```

#### 4. **Code-Duplikation**
- ElevenLabs Integration in 2 Services
- Upload-Logik mehrfach implementiert
- √Ñhnliche Fehlerbehandlung √ºberall

### üü¢ Positive Aspekte

#### 1. **Gute Service-Trennung**
- Klare Verantwortlichkeiten
- Microservice-Architektur
- Docker-Integration

#### 2. **Robuste AI-Integration**
- Async/Await korrekt verwendet
- Modell-Initialisierung gut abstrahiert
- GPU/CPU Fallback implementiert

#### 3. **Umfangreiche API**
- Viele n√ºtzliche Endpunkte
- Gute HTTP-Status-Codes
- JSON-Responses standardisiert

### üîß Verbesserungsvorschl√§ge

#### 1. **Sicherheit**
```python
# Environment-based Konfiguration
class Config:
    ELEVENLABS_API_KEY = os.environ.get('ELEVENLABS_API_KEY')
    DEBUG = os.environ.get('DEBUG', 'False').lower() == 'true'
    LOG_LEVEL = os.environ.get('LOG_LEVEL', 'INFO')
```

#### 2. **Code-Struktur**
```python
# Aufteilen in Module
services/analyzer/
‚îú‚îÄ‚îÄ main.py              # Nur API-Endpunkte
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ visual_analysis.py
‚îÇ   ‚îî‚îÄ‚îÄ scene_detection.py
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ ffmpeg_utils.py
‚îÇ   ‚îî‚îÄ‚îÄ file_utils.py
‚îî‚îÄ‚îÄ config.py           # Zentrale Konfiguration
```

#### 3. **Logging**
```python
import logging
import structlog

# Strukturiertes Logging
logger = structlog.get_logger(__name__)

def analyze_video(video_path: str):
    logger.info("Starting video analysis", video_path=video_path)
    try:
        # processing
        logger.info("Video analysis completed", 
                   scenes_found=len(scenes))
    except Exception as e:
        logger.error("Video analysis failed", 
                    error=str(e), video_path=video_path)
```

#### 4. **Testing**
```python
# Unit Tests hinzuf√ºgen
tests/
‚îú‚îÄ‚îÄ test_analyzer.py
‚îú‚îÄ‚îÄ test_whisper.py
‚îú‚îÄ‚îÄ test_integration.py
‚îî‚îÄ‚îÄ fixtures/
    ‚îî‚îÄ‚îÄ sample_video.mp4
```

#### 5. **Dokumentation**
```python
def analyze_scenes(video_path: str, threshold: float = 18.0, 
                  min_scene_len: int = 8) -> List[Scene]:
    """
    Analysiert Video und erkennt Szenen-√úberg√§nge.
    
    Args:
        video_path: Pfad zur Video-Datei
        threshold: Sensitivit√§t f√ºr Szenen-Erkennung (h√∂her = weniger Szenen)
        min_scene_len: Minimale Szenen-L√§nge in Frames
        
    Returns:
        Liste von Scene-Objekten mit Screenshots und Metadaten
        
    Raises:
        FileNotFoundError: Wenn Video-Datei nicht existiert
        ValueError: Bei ung√ºltigen Parametern
    """
```

---

## üöÄ Deployment & Konfiguration

### üìã Docker-Compose-Analyse

#### Services-√úbersicht:
```yaml
services:
  gencut-frontend:      # Port 5679 (Cutdown Generator)
  revoice:             # Port 5682 (Revoice Service)
  analyzer:            # Port 8000 (Video Analysis)
  whisper:             # Port 9000 (Speech-to-Text)
  imagebind-embed:     # Port 8750 (Nicht aktiv genutzt)
  nginx:               # Port 5679 (Reverse Proxy)
```

#### Netzwerk-Architektur:
```yaml
networks:
  n8n-network:         # Externe Integration
  video-network:       # Interne Service-Kommunikation
```

#### Volume-Management:
```yaml
volumes:
  static_data:         # CSS/JS Assets
  videos_data:         # Video-Dateien (geteilt)
```

### üîß Nginx-Konfiguration

```nginx
# nginx.conf - Reverse Proxy Setup
server {
    listen 5679;
    client_max_body_size 2g;  # Gro√üe Video-Uploads
    
    location /static/ {
        alias /app/static/;
    }
    
    location /videos/ {
        alias /app/videos/;
        # Video-Streaming optimiert
    }
    
    location / {
        proxy_pass http://gencut-frontend:5679;
        proxy_read_timeout 300s;  # Lange Verarbeitung
    }
}
```

### üõ†Ô∏è Build & Setup

#### `build-and-run.sh` - Automatisiertes Setup
```bash
# Vollst√§ndiges Setup in einem Script
# ‚úÖ Netzwerk-Erstellung
# ‚úÖ Service-Building
# ‚úÖ Health-Checks
# ‚úÖ Status-√úbersicht
```

**Verbesserungen**:
- Health-Check-Timeout erh√∂hen
- Bessere Fehlerbehandlung bei Service-Ausf√§llen
- Log-Aggregation hinzuf√ºgen

---

## üìö API-Dokumentation

### üîç Analyzer Service (Port: 8000)

#### POST `/analyze`
**Zweck**: Vollst√§ndige Video-Analyse mit KI
```json
// Request: multipart/form-data
{
  "file": "video.mp4"
}

// Response:
{
  "video_id": "uuid",
  "filename": "video.mp4",
  "scenes": [
    {
      "scene": 0,
      "start_time": "00:00:00.000",
      "end_time": "00:00:05.123",
      "screenshots": [
        {
          "url": "/videos/screenshots/video/scene_000_frame_000.jpg",
          "timestamp": "0:00:01.500000",
          "frame_number": 45
        }
      ]
    }
  ]
}
```

#### POST `/separate-path`
**Zweck**: Video/Audio-Trennung
```json
// Request:
{
  "file": "/app/videos/uploads/video.mp4"
}

// Response:
{
  "filename": "video.mp4",
  "video_url": "/separated/video_video.mp4",
  "audio_url": "/separated/video_audio.mp3"
}
```

#### POST `/generate-cutdown-v2`
**Zweck**: Cutdown aus ausgew√§hlten Szenen
```json
// Request:
{
  "selected_scenes": [
    {
      "start_time": "00:00:10.000",
      "end_time": "00:00:15.000",
      "video_url": "/videos/uploads/video.mp4"
    }
  ],
  "audio_file": "http://example.com/music.mp3",
  "original_video": "/app/videos/uploads/video.mp4"
}

// Response:
{
  "output_url": "/videos/cutdowns/generated_cutdown.mp4"
}
```

### üéôÔ∏è Whisper Service (Port: 9000)

#### POST `/asr`
**Zweck**: Audio-zu-Text Transkription
```json
// Request: multipart/form-data
{
  "audio_file": "audio.mp3",
  "language_code": "de"  // Optional
}

// Response:
{
  "text": "Transkribierter Text",
  "language": "de",
  "segments": [
    {
      "start": 0.0,
      "end": 5.0,
      "text": "Segment-Text"
    }
  ]
}
```

### üé¨ Cutdown Generator (Port: 5679)

#### POST `/upload`
**Zweck**: Video-Upload f√ºr Cutdown-Generation
```json
// Request: multipart/form-data
{
  "video": "video.mp4",
  "cutdown_options": {
    "length": "60",
    "style": "highlight",
    "focus": ["action"]
  },
  "prompt": "Erstelle einen actionreichen Cutdown"
}

// Response:
{
  "success": true,
  "video_id": "uuid",
  "filename": "uuid_video.mp4",
  "status": "uploaded",
  "webhook_status": "success"
}
```

#### POST `/check-status`
**Zweck**: Verarbeitungsstatus pr√ºfen
```json
// Request:
{
  "video_id": "uuid"
}

// Response:
{
  "status": "completed|processing|failed",
  "message": "Status-Beschreibung",
  "cutdown_path": "/videos/cutdowns/result.mp4"  // Falls fertig
}
```

### üîä Revoice Service (Port: 5682)

#### POST `/upload`
**Zweck**: Video-Upload f√ºr Revoicing
```json
// Request: multipart/form-data
{
  "video": "video.mp4"
}

// Response:
{
  "success": true,
  "video_id": "revoice_timestamp_hash",
  "filename": "revoice_id.mp4",
  "status": "processing"
}
```

#### GET `/elevenlabs/voices`
**Zweck**: Verf√ºgbare Stimmen abrufen
```json
// Response:
[
  {
    "voice_id": "voice_id",
    "name": "Voice Name",
    "labels": {"gender": "male", "age": "adult"},
    "description": "Voice description",
    "category": "premade"
  }
]
```

---

## üìà Performance & Monitoring

### üîç Performance-Optimierungen

#### 1. **Video-Processing**
- FFmpeg mit `ultrafast` Preset
- Screenshot-Kompression (JPEG Quality 85)
- Nur mittlere Frames pro Szene analysiert

#### 2. **AI-Modell-Optimierung**
- GPU/CPU Fallback
- Modell-Caching
- Async-Verarbeitung

#### 3. **File-Handling**
- Tempor√§re Dateien automatisch bereinigt
- Streaming f√ºr gro√üe Dateien
- Nginx-Optimierung f√ºr Video-Serving

### üìä Monitoring-Endpunkte

```python
# Health-Check-Endpunkte in allen Services
GET /health

// Beispiel-Response:
{
  "status": "healthy",
  "service": "analyzer",
  "timestamp": 1234567890,
  "models_loaded": true,
  "gpu_available": false
}
```

---

## üéØ Empfohlene N√§chste Schritte

### üî¥ Kritisch (Sofort):
1. **API-Keys aus Code entfernen**
2. **Debug-Modus deaktivieren**
3. **Verwaiste Dateien l√∂schen**

### üü° Hoch (Diese Woche):
1. **Code in Module aufteilen**
2. **Einheitliche Fehlerbehandlung**
3. **Service-Duplikation bereinigen**

### üü¢ Mittel (N√§chste Iteration):
1. **Unit-Tests hinzuf√ºgen**
2. **Logging verbessern**
3. **Performance-Monitoring**

### üîµ Niedrig (Langfristig):
1. **OpenAPI-Dokumentation**
2. **CI/CD Pipeline**
3. **Load-Balancing**

---

## üìû Fazit

**GenCut** ist ein **funktionales und gut strukturiertes** Video-Analyse-System mit moderner Microservice-Architektur. Die AI-Integration ist robust implementiert und die Service-Trennung ist sauber durchgef√ºhrt.

**Hauptst√§rken**:
- ‚úÖ Vollst√§ndige AI-Pipeline (Vision + Audio)
- ‚úÖ Saubere Docker-Integration
- ‚úÖ Umfangreiche API
- ‚úÖ n8n Workflow-Integration

**Kritische Verbesserungen**:
- üî¥ Sicherheitsprobleme (API-Keys)
- üî¥ Code-Bereinigung erforderlich
- üî¥ Service-Duplikation

**Gesamtbewertung**: ‚≠ê‚≠ê‚≠ê‚≠ê (4/5) - Sehr gut mit Verbesserungspotential

Mit den empfohlenen Verbesserungen kann das System auf **Produktionsniveau** gebracht werden.